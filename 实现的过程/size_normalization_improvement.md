# 结构光3D扫描系统图像尺寸标准化功能改进

## 1. 背景介绍

在结构光3D扫描系统中，条纹图和灰码图的分辨率一致性对于相位解包裹的准确性至关重要。在实际应用中，由于相机参数设置、图像预处理或外部因素，可能导致输入的条纹图和灰码图具有不同的分辨率，从而引发解包裹过程中的尺寸不匹配错误。这次改进针对该问题，增加了自动图像尺寸标准化功能，确保所有输入图像在处理过程中具有相同的分辨率。

## 2. 主要问题

在原有系统中，当条纹图和灰码图的尺寸不一致时，会出现以下问题：

- 在计算包裹相位与灰码解码结果合并时发生尺寸不匹配错误
- 警告信息提示条纹图像和灰码图像尺寸不一致（如768x1024 vs 480x640）
- 系统自动裁剪到最小尺寸的处理方式不透明，用户无法控制

## 3. 改进内容概述

本次改进主要包含以下内容：

1. **图像尺寸标准化工具函数**：添加`normalize_image_size`函数，支持裁剪和缩放两种尺寸调整方式
2. **统一的尺寸标准**：为各个处理类增加尺寸标准存储和传递机制
3. **用户交互选项**：允许用户选择尺寸标准化的方法和目标尺寸
4. **测试数据生成支持**：修改测试数据生成功能，使其支持标准尺寸
5. **详细的尺寸信息输出**：在处理过程中清晰显示各类图像的尺寸信息

## 4. 技术实现详情

### 4.1 图像尺寸标准化核心功能

添加了`normalize_image_size`函数，该函数可以：
- 自动计算多幅图像的公共最小尺寸
- 支持裁剪模式（从左上角裁剪到目标尺寸）
- 支持缩放模式（使用OpenCV的resize函数调整图像尺寸）
- 处理None值和空列表的边界情况

```python
def normalize_image_size(images, target_size=None, method="crop"):
    """
    将一组图像标准化为相同的尺寸
    
    参数:
        images: 单张图像或图像列表
        target_size: 目标尺寸(height, width)，如果为None则使用所有图像的最小尺寸
        method: 尺寸调整方法，可选值为"crop"(裁剪)或"resize"(缩放)
        
    返回:
        标准化后的图像或图像列表
    """
```

### 4.2 各处理类的改进

1. **WrappedPhase类**：
   - 增加标准尺寸和方法属性
   - 修改`getImageData`方法，支持图像标准化
   - 添加尺寸信息输出

2. **Binariization类**：
   - 添加尺寸标准化支持
   - 修改`get_threshold`和`get_GC_images`方法
   - 增加尺寸不一致警告和处理

3. **UnwrappedPhase类**：
   - 增加标准尺寸传递机制
   - 修改`getBinarizedGrayCodes`方法
   - 改进`computeUnwrappedPhase`方法，使其在检测到尺寸不一致时能够智能处理
   - 增强`generate_test_patterns`方法，使测试数据符合标准尺寸

### 4.3 主程序流程改进

在主程序中添加了图像尺寸标准化选项，用户可以：
- 选择自动裁剪到最小尺寸（默认）
- 选择缩放所有图像到相同尺寸
- 手动指定目标尺寸和调整方法

## 5. 用户使用指南

程序启动后，除了原有的显示选项和解包裹方向选项外，用户现在可以选择以下图像尺寸标准化选项：

```
图像尺寸标准化选项：
1. 自动裁剪到最小尺寸 (默认)
2. 缩放所有图像到相同尺寸
3. 手动指定目标尺寸
```

当选择选项3时，用户可以输入：
- 目标宽度（像素）
- 目标高度（像素）
- 调整方法（裁剪或缩放）

程序会根据用户的选择对所有输入图像进行标准化处理，并在处理过程中显示详细的尺寸信息。

## 6. 改进效果与优势

本次改进带来的主要优势包括：

1. **增强鲁棒性**：系统能够自动处理不同分辨率的输入图像
2. **用户控制**：用户可以根据需要选择最合适的尺寸调整方式
3. **信息透明**：处理过程中清晰显示尺寸信息，便于用户了解和调试
4. **结果一致性**：确保水平和垂直方向的解包裹结果基于相同尺寸的输入数据
5. **异常处理**：改进了异常处理机制，即使在图像尺寸不一致的情况下也能稳定运行

## 7. 注意事项

- 裁剪模式可能导致图像边缘信息丢失，但保持原始像素精确性
- 缩放模式保留完整图像内容，但可能因插值导致细节信息变化
- 如果输入图像尺寸差异极大，建议手动指定合理的目标尺寸

## 8. 后续改进方向

- 支持更多的图像插值方法（如双三次插值、Lanczos插值等）
- 添加图像中心裁剪选项
- 实现智能裁剪，保留图像中信息最丰富的区域
- 添加图像对齐功能，在标准化前对图像进行自动对齐

---

*文档创建日期：2023年12月* 